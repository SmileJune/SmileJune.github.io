---
layout: post
title: μ¤ν”„λ§ AOP
date: 2023-07-14 20:55 +0900
---

# μ¤ν”„λ§ AOP (Aspect Oriented Programming, κ΄€μ  μ§€ν–¥ ν”„λ΅κ·Έλλ°)

## μ†κ°

AOPλ” ν”„λ΅κ·Έλ¨ κµ¬μ΅°μ—μ— λ€ν• λ λ‹¤λ¥Έ μ‚¬κ³  λ°©μ‹μ„ μ κ³µν•μ—¬ κ°μ²΄ μ§€ν–¥ ν”„λ΅κ·Έλλ°(OOP)μ„ λ³΄μ™„ν•©λ‹λ‹¤. OOPμ—μ„ λ¨λ“μ„±μ ν•µμ‹¬ λ‹¨μ„λ” ν΄λμ¤μΈ λ°λ©΄ AOPμ—μ„λ” λ¨λ“μ„±μ λ‹¨μ„κ°€ **aspect**μ…λ‹λ‹¤. **Aspect**λ” μ—¬λ¬ μ ν•κ³Ό κ°μ²΄λ¥Ό κ°€λ΅μ§€λ¥΄λ” νΈλμ­μ… κ΄€λ¦¬μ™€ κ°™μ€ λ¬Έμ μ λ¨λ“ν™”λ¥Ό κ°€λ¥ν•κ² ν•©λ‹λ‹¤.

## AOP κ°λ…

- Aspect : μ—¬λ¬ ν΄λμ¤μ— κ±Έμ³ μλ” κ΄€μ‹¬μ‚¬μ λ¨λ“ν™”.
- Join point : λ©”μ„λ“ μ‹¤ν–‰μ΄λ‚ μμ™Έ μ²λ¦¬ν•  λ•μ Point. Spring AOPμ—μ„ join pointλ” λ©”μ„λ“μ μ‹¤ν–‰μ„ λ‚νƒ€λƒ…λ‹λ‹¤.
- Advice : νΉμ •ν• join pointμ—μ„ Aspectκ°€ μ·¨ν•λ” ν–‰λ™. β†’ Springμ„ ν¬ν•¨ν• λ§μ€ AOP ν”„λ μ„μ›ν¬λ” adviceλ¥Ό μΈν„°μ…‰ν„°λ΅ λ¨λΈλ§ν•κ³  μ΅°μΈ ν¬μΈνΈ μ£Όλ³€μ— μΈν„°μ…‰ν„° μ²΄μΈμ„ μ μ§€ν•©λ‹λ‹¤.
  - around
  - before
  - after
- Pointcut : μ΅°μΈ ν¬μΈνΈμ™€ μΌμΉν•λ” μ μ–΄. Adviceλ” pointcut ν‘ν„μ‹κ³Ό μ—°κ΄€λλ©° pointcutκ³Ό μΌμΉν•λ” λ¨λ“  μ΅°μΈ ν¬μΈνΈμ—μ„ μ‹¤ν–‰λ©λ‹λ‹¤. Springμ€ κΈ°λ³Έμ μΌλ΅ AspectJ pointcut ν‘ν„μ‹μ„ μ‚¬μ©ν•©λ‹λ‹¤.
- Introduction : νƒ€μ…μ„ λ€μ‹ ν•μ—¬ μ¶”κ°€μ μΈ λ©”μ„λ“λ‚ ν•„λ“λ¥Ό μ„ μ–Έν•©λ‹λ‹¤. Spring AOPλ¥Ό μ‚¬μ©ν•λ©΄ adviceλ κ°μ²΄μ— μƒλ΅μ΄ μΈν„°νμ΄μ¤(λ° κµ¬ν„)λ¥Ό λ„μ…ν•  μ μμµλ‹λ‹¤.
- Target object : ν•λ‚ μ΄μƒμ aspectμ— μν•΄ adviceλλ” κ°μ²΄. Spring AOPλ” λ°νƒ€μ„ ν”„λ΅μ‹λ¥Ό μ‚¬μ©ν•μ—¬ κµ¬ν„λλ―€λ΅ μ΄ κ°μ²΄λ” ν•­μƒ ν”„λ΅μ‹ κ°μ²΄μ…λ‹λ‹¤.
    <aside>
    π’΅ λ°νƒ€μ„ ν”„λ΅μ‹λ€?
    κ°μ²΄ μ§€ν–¥ ν”„λ΅κ·Έλλ°μ—μ„ κ°μ²΄ κ°„μ μƒνΈ μ‘μ©μ„ μ¤‘κ°„μ—μ„ κ°€λ΅μ±„λ” μ—­ν• μ„ ν•©λ‹λ‹¤.
    ν”„λ΅μ‹λ” μ‹¤μ  κ°μ²΄μ— λ€ν• λ€λ¦¬μλ΅ λ™μ‘ν•λ©°, ν΄λΌμ΄μ–ΈνΈκ°€ κ°μ²΄μ— μ§μ ‘ μ ‘κ·Όν•λ” λ€μ‹ μ— ν”„λ΅μ‹λ¥Ό ν†µν•΄ μƒνΈ μ‘μ©ν•©λ‹λ‹¤.
    
    ν”„λ΅μ‹ ν¨ν„΄μ€ OOP μ›μΉ™ μ¤‘ ν•λ‚μΈ β€κ°λ°©-νμ‡„ μ›μΉ™(OCP)β€μ„ λ”°λ¥΄λ” λ°©μ‹μΌλ΅ μ½”λ“λ¥Ό μ‘μ„±ν•  μ μκ² ν•΄μ¤λ‹λ‹¤. ν΄λΌμ΄μ–ΈνΈ μ½”λ“λ” μ‹¤μ²΄κ°€ μ•„λ‹ ν”„λ΅μ‹μ™€ μƒνΈ μ‘μ©ν•λ―€λ΅, κ°μ²΄μ κµ¬ν„μ„ λ³€κ²½ν•μ§€ μ•κ³ λ„ ν”„λ΅μ‹λ¥Ό ν†µν•΄ λ‹¤μ–‘ν• λ™μ‘μ„ μ¶”κ°€ν•κ±°λ‚ μμ •ν•  μ μμµλ‹λ‹¤.
    
    </aside>

- AOP proxy : aspect contracts(λ©”μ„λ“ μ‹¤ν–‰μ— advice λ“±)μ„ κµ¬ν„ν•κΈ° μ„ν•΄ AOP ν”„λ μ„μ›ν¬μ— μν•΄ μƒμ„±λ κ°μ²΄. Spring Frameworkμ—μ„ AOP ν”„λ΅μ‹λ” JDK λ™μ  ν”„λ΅μ‹ λλ” CGLIBν”„λ΅μ‹ μ…λ‹λ‹¤.
- Weaving : aspectλ¥Ό λ‹¤λ¥Έ μ• ν”λ¦¬μΌ€μ΄μ… μ ν• λλ” κ°μ²΄μ™€ μ—°κ²°ν•μ—¬ adivceλ κ°μ²΄λ¥Ό μƒμ„±ν•©λ‹λ‹¤. Spring AOPλ” λ‹¤λ¥Έ μμ Java AOP ν”„λ μ„μ›ν¬μ™€ λ§μ°¬κ°€μ§€λ΅ λ°νƒ€μ„μ— weavingμ„ μν–‰ν•©λ‹λ‹¤.

## Spring AOPμ adivce μΆ…λ¥

- Before advice : μ΅°μΈ ν¬μΈνΈ μ΄μ „μ— μ‹¤ν–‰λμ§€λ§ μ΅°μΈ ν¬μΈνΈλ΅ μ§„ν–‰ν•λ” μ‹¤ν–‰ νλ¦„μ„ λ°©μ§€ν•λ” κΈ°λ¥μ΄ μ—†λ” advice. (μμ™Έκ°€ λ°μƒν•μ§€ μ•λ” ν•)
- After returning advice : μ΅°μΈ ν¬μΈνΈκ°€ μ •μƒμ μΌλ΅ μ™„λ£λ ν›„ μ‹¤ν–‰ν•  advice.
- After throwing advice : μμ™Έλ¥Ό throwν•μ—¬ λ©”μ„λ“κ°€ μΆ…λ£λλ” κ²½μ° μ‹¤ν–‰ν•  advice.
- After (finally) advice : μ΅°μΈ ν¬μΈνΈκ°€ μΆ…λ£λλ” μλ‹¨(μ •μƒ λλ” μμ™Έ λ°ν™)μ— κ΄€κ³„μ—†μ΄ μ‹¤ν–‰ν•  advice.
- Around advice : λ©”μ„λ“ νΈμ¶κ³Ό κ°™μ€ μ΅°μΈ ν¬μΈνΈλ¥Ό λ‘λ¬μ‹Έλ” advice. λ©”μ„λ“ νΈμ¶ μ „ν›„μ— μ‚¬μ©μ μ •μ λ™μ‘μ„ μν–‰ν•  μ μμµλ‹λ‹¤. μμ²΄ return κ°’μ„ λ°ν™ν•κ±°λ‚ μμ™Έλ¥Ό throwν•μ—¬ μ΅°μΈ μ§€μ μΌλ΅ μ§„ν–‰λ μ§€ λλ” κ¶μ¥λ λ©”μ„λ“ μ‹¤ν–‰μ„ λ‹¨μ¶•ν• μ§€ μ—¬λ¶€λ¥Ό μ„ νƒν•  μ±…μ„μ΄ μμµλ‹λ‹¤.

## AOP ν”„λ μ„μ›ν¬ μ„ νƒ λ°©λ²•

- AspectJ
- Spring AOP

[Choosing which AOP Declaration Style to Use :: Spring Framework](https://docs.spring.io/spring-framework/reference/core/aop/choosing.html)

## @AspectJ μ‚¬μ©λ²•

**Config νμΌ**

```java
@Configuration
@EnableAspectJAutoProxy
public class AppConfig {

}
```

@AspectJ μ§€μ›μ΄ ν™μ„±ν™”λλ©΄ Aspect μ–΄λ…Έν…μ΄μ…μ„ λ‹¬μ•„ μ–΄ν”λ¦¬μΌ€μ΄μ… μ»¨ν…μ¤νΈμ— μ •μλ λ¨λ“  λΉμ΄ Springμ—μ„ μλ™μΌλ΅ κ°μ§€λκ³  Spring AOPλ¥Ό κµ¬μ„±ν•λ” λ° μ‚¬μ©λ©λ‹λ‹¤.

```java
package org.xyz;
import org.aspectj.lang.annotation.Aspect;

@Aspect
public class NotVeryUsefulAspect {

}
```

pointcut μ„ μ–Έμ€ μ΄λ¦„κ³Ό λ§¤κ°λ³€μλ¥Ό ν¬ν•¨ν•λ” μ„λ…κ³Ό μ°λ¦¬κ°€ κ΄€μ‹¬ μλ” λ©”μ†λ“ μ‹¤ν–‰μ„ μ •ν™•ν κ²°μ •ν•λ” pointcut ν‘ν„μ‹μΒ **λ‘ λ¶€λ¶„μΌλ΅ κµ¬μ„±**λ©λ‹λ‹¤.

μ•„λ μμ λ” transferλΌλ” λ©”μ„λ“μ μ‹¤ν–‰κ³Ό μΌμΉν•λ” anyOldTransferλΌλ” ν¬μΈνΈμ»·μ„ μ •μν•©λ‹λ‹¤.

```java
@Pointcut("execution(* transfer(..))") // the pointcut expression
private void anyOldTransfer() {} // the pointcut signature
```

### **Before Advice**

```java
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.Before;

@Aspect
public class BeforeExample {

    @Before("com.xyz.myapp.CommonPointcuts.dataAccessOperation()")
    public void doAccessCheck() {
        // ...
    }
}
```

### After Returning Advice

```java
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.AfterReturning;

@Aspect
public class AfterReturningExample {

    @AfterReturning("com.xyz.myapp.CommonPointcuts.dataAccessOperation()")
    public void doAccessCheck() {
        // ...
    }
}
```

### After Throwing Advice

```java
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.AfterThrowing;

@Aspect
public class AfterThrowingExample {

    @AfterThrowing("com.xyz.myapp.CommonPointcuts.dataAccessOperation()")
    public void doRecoveryActions() {
        // ...
    }
}
```

### After (Finally) Advice

```java
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.After;

@Aspect
public class AfterFinallyExample {

    @After("com.xyz.myapp.CommonPointcuts.dataAccessOperation()")
    public void doReleaseLock() {
        // ...
    }
}
```

### Around Advice

around adviceλ”Β **μΌμΉν•λ” λ©”μ„λ“κ°€ μ‹¤ν–‰λλ” λ™μ• μ‹¤ν–‰**ν•©λ‹λ‹¤. λ©”μ„λ“ μ‹¤ν–‰ μ „ν›„μ— μ‘μ—…μ„ μν–‰ν•κ³  λ©”μ„λ“κ°€ μ‹¤μ λ΅ μ‹¤ν–‰λλ” μ‹κΈ°μ™€ λ°©λ²•, μ‹¤ν–‰ μ—¬λ¶€λ¥Ό κ²°μ •ν•  μ μλ” κΈ°νκ°€ μμµλ‹λ‹¤. μ–΄λΌμ΄λ“ μ–΄λ“λ°”μ΄μ¤λ” μ¤λ λ“λ΅λ¶€ν„° μ•μ „ν• λ°©μ‹(μ: νƒ€μ΄λ¨Έ μ‹μ‘ λ° μ¤‘μ§€)μΌλ΅ λ©”μ„λ“ μ‹¤ν–‰ μ „ν›„μ μƒνƒλ¥Ό κ³µμ ν•΄μ•Ό ν•λ” κ²½μ°μ— μμ£Ό μ‚¬μ©λ©λ‹λ‹¤.

```java
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.Around;
import org.aspectj.lang.ProceedingJoinPoint;

@Aspect
public class AroundExample {

    @Around("com.xyz.myapp.CommonPointcuts.businessService()")
    public Object doBasicProfiling(ProceedingJoinPoint pjp) throws Throwable {
        // start stopwatch
        Object retVal = pjp.proceed();
        // stop stopwatch
        return retVal;
    }
}
```

### Introductions

Introductions(AspectJμ—μ„ μ ν• κ°„ μ„ μ–ΈμΌλ΅ μ•λ ¤μ§)λ¥Ό ν†µν•΄ Aspectλ” μ΅°μ–Έλ κ°μ²΄κ°€ μ£Όμ–΄μ§„ μΈν„°νμ΄μ¤λ¥Ό κµ¬ν„ν•λ‹¤κ³  μ„ μ–Έν•κ³  ν•΄λ‹Ή κ°μ²΄λ¥ΌΒ λ€μ‹ ν•μ—¬ ν•΄λ‹Ή μΈν„°νμ΄μ¤μ κµ¬ν„μ„ μ κ³µν•  μ μμµλ‹λ‹¤.

```java
@Aspect
public class UsageTracking {

    @DeclareParents(value="com.xzy.myapp.service.*+", defaultImpl=DefaultUsageTracked.class)
    public static UsageTracked mixin;

    @Before("com.xyz.myapp.CommonPointcuts.businessService() && this(usageTracked)")
    public void recordUsage(UsageTracked usageTracked) {
        usageTracked.incrementUseCount();
    }

}
```

**μ°Έκ³  μλ£**

[ChapterΒ 9.Β Transaction management](https://docs.spring.io/spring-framework/docs/2.5.5/reference/transaction.html#transaction-declarative)

[[λ²μ—­] Spring κ³µμ‹λ¬Έμ„ - Aspect Oriented Programming](https://velog.io/@orijoon98/Spring-Framework-Documentation3-Aspect-Oriented-Programming)
